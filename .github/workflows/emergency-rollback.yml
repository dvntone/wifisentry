name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      rollback-version:
        description: 'Version to rollback to (e.g., 1.0.0)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
      branch-exists: ${{ steps.check.outputs.branch-exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version exists
        id: check
        run: |
          VERSION="${{ github.event.inputs.rollback-version }}"
          TAG="v$VERSION"
          
          echo "üîç Checking for version $VERSION..."
          
          # Check if tag exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚úÖ Tag $TAG found"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Tag $TAG not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if backup branch exists
          BRANCH="release/v$VERSION"
          if git rev-parse "origin/$BRANCH" >/dev/null 2>&1; then
            echo "‚úÖ Backup branch $BRANCH found"
            echo "branch-exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Backup branch $BRANCH not found (will rollback from tag)"
            echo "branch-exists=false" >> $GITHUB_OUTPUT
          fi

  rollback:
    needs: validate-version
    if: needs.validate-version.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Perform rollback
        id: rollback
        run: |
          VERSION="${{ github.event.inputs.rollback-version }}"
          TAG="v$VERSION"
          REASON="${{ github.event.inputs.reason }}"
          
          echo "‚èÆÔ∏è  Rolling back to version $VERSION..."
          echo "Reason: $REASON"
          echo ""
          
          # Get commit hash of the tag
          ROLLBACK_COMMIT=$(git rev-list -n 1 $TAG)
          echo "Rollback commit: $ROLLBACK_COMMIT"
          
          # Reset to tag (soft reset to preserve files)
          git reset --soft $TAG
          
          # Update package.json version
          jq ".version = \"$VERSION\"" package.json > package.json.tmp
          mv package.json.tmp package.json
          
          # Create rollback commit
          git add package.json
          git commit -m "‚èÆÔ∏è  Rollback to v$VERSION

Reason: $REASON
Previous commit: $(git rev-parse HEAD~1 | cut -c1-7)
Rollback to: $ROLLBACK_COMMIT"
          
          # Tag the rollback
          git tag -a "v${VERSION}-rollback-$(date +%s)" -m "Rollback to $VERSION - Reason: $REASON"
          
          # Push changes
          git push origin main
          git push origin --tags
          
          echo "‚úÖ Rolled back to v$VERSION"
          echo "commit=$ROLLBACK_COMMIT" >> $GITHUB_OUTPUT

      - name: Create rollback release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.rollback-version }}-hotfix
          release_name: üö® Emergency Rollback to v${{ github.event.inputs.rollback-version }}
          body: |
            ## üö® Emergency Rollback
            
            **Rolled back to:** v${{ github.event.inputs.rollback-version }}
            **Reason:** ${{ github.event.inputs.reason }}
            **Previous version:** ${{ env.PREVIOUS_VERSION }}
            **Rollback Time:** ${{ github.event.repository.updated_at }}
            
            ### Actions Taken
            - ‚úÖ Main branch reset to v${{ github.event.inputs.rollback-version }}
            - ‚úÖ package.json updated
            - ‚úÖ Rollback commit created
            - ‚úÖ Backup branches preserved for recovery
            
            ### Next Steps
            1. Review the changes that were rolled back
            2. Fix the issues that caused the rollback
            3. Test thoroughly before re-releasing
            4. Create a new patch/minor/major version
          draft: false
          prerelease: true

      - name: Notification
        run: |
          echo "üö® ROLLBACK COMPLETED"
          echo ""
          echo "Version: v${{ github.event.inputs.rollback-version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Status: ‚úÖ Main branch rolled back"
          echo ""
          echo "‚ö†Ô∏è  Important:"
          echo "  ‚Ä¢ All backup branches remain available for recovery"
          echo "  ‚Ä¢ Review git log to see what was reverted"
          echo "  ‚Ä¢ Test before deploying again"
          echo ""
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.rollback-version }}-hotfix"
