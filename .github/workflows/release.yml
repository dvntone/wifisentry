name: Release - Build & Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.1)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag or input
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION=${{ github.event.inputs.version }}
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Create Release Notes
        id: release_notes
        run: |
          echo "# WiFi Sentry ${{ steps.version.outputs.VERSION }}" > release_notes.md
          echo "" >> release_notes.md
          echo "## Changes in this release:" >> release_notes.md
          echo "" >> release_notes.md
          git log --oneline --no-decorate $(git describe --tags --abbrev=0 @^)..@ >> release_notes.md 2>/dev/null || echo "Initial release" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Platform Support:" >> release_notes.md
          echo "- âœ… Windows Desktop (Electron) - x64" >> release_notes.md
          echo "- âœ… Android Mobile (Capacitor)" >> release_notes.md
          echo "- âœ… Web PWA" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-release:
    name: Build Windows Release
    runs-on: windows-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Install web-app dependencies
        working-directory: web-app
        run: npm install

      - name: Build Windows app
        run: npm run desktop:build

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/**/*.exe
            dist/**/*.nsis
            dist/**/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android-release:
    name: Build Android Release
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        # Uses action defaults; installs SDK command-line tools sufficient for
        # the compileSdk/targetSdk levels declared in the Gradle files.
        uses: android-actions/setup-android@v3

      - name: Make gradlew executable
        working-directory: android-native
        run: chmod +x ./gradlew

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android-native/**/*.gradle', 'android-native/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Android unit tests
        working-directory: android-native
        run: ./gradlew :core:test

      - name: Build Android dev release APK
        working-directory: android-native
        run: ./gradlew :app:assembleDevRelease --stacktrace

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            android-native/app/build/outputs/apk/dev/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-web-release:
    name: Build Web Release
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Install web-app dependencies
        working-directory: web-app
        run: npm install

      - name: Build web application
        run: npm run web:build

      - name: Create web archive
        run: |
          cd web-app
          tar -czf ../wifi-sentry-web-${{ github.ref_name }}.tar.gz out/
          zip -r ../wifi-sentry-web-${{ github.ref_name }}.zip out/

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            wifi-sentry-web-*.tar.gz
            wifi-sentry-web-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-notification:
    name: Publish Release Notification
    runs-on: ubuntu-latest
    needs: [create-release, build-windows-release, build-android-release, build-web-release]
    if: always()

    steps:
      - name: Determine release URL
        id: release_url
        run: |
          VERSION="${{ needs.create-release.outputs.VERSION }}"
          if [ -z "$VERSION" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "URL=${{ github.server_url }}/${{ github.repository }}/releases/tag/${VERSION}" >> "$GITHUB_OUTPUT"
          echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Write release summary
        run: |
          WINDOWS="${{ needs.build-windows-release.result }}"
          ANDROID="${{ needs.build-android-release.result }}"
          WEB="${{ needs.build-web-release.result }}"
          VERSION="${{ steps.release_url.outputs.VERSION }}"
          RELEASE_URL="${{ steps.release_url.outputs.URL }}"

          status_icon() { [ "$1" = "success" ] && echo "âœ…" || echo "âŒ"; }

          ALL_OK="true"
          [ "$WINDOWS" != "success" ] && ALL_OK="false"
          [ "$ANDROID" != "success" ] && ALL_OK="false"
          [ "$WEB"     != "success" ] && ALL_OK="false"

          if [ "$ALL_OK" = "true" ]; then
            echo "## âœ… WiFi Sentry ${VERSION} Released" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "All platform builds succeeded. The release is ready to download." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## âš ï¸ WiFi Sentry ${VERSION} â€” Partial Release" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "One or more platform builds did not succeed. Check the jobs above for details." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**[ðŸ”— View GitHub Release](${RELEASE_URL})**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Platform | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Windows Desktop (Electron x64) | $(status_icon $WINDOWS) ${WINDOWS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Android Mobile (dev release APK) | $(status_icon $ANDROID) ${ANDROID} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Web PWA | $(status_icon $WEB) ${WEB} |" >> "$GITHUB_STEP_SUMMARY"
