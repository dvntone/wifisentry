name: Auto Release & Version Backup

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      previous-version: ${{ steps.version.outputs.previous-version }}
      version-changed: ${{ steps.version.outputs.changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Detect version changes
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(jq -r '.version' package.json)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          
          # Get previous version from last tag or git log
          PREVIOUS_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          PREVIOUS_VERSION=${PREVIOUS_VERSION#v}  # Remove v prefix if present
          echo "previous-version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREVIOUS_VERSION"
          
          # Check if version changed
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Version unchanged ($CURRENT_VERSION)"
          fi

  generate-changelog:
    needs: detect-version
    if: needs.detect-version.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog with diffs
        id: changelog
        run: |
          VERSION=${{ needs.detect-version.outputs.version }}
          PREV_VERSION=${{ needs.detect-version.outputs.previous-version }}
          
          # Determine commit range
          if git rev-list "v$PREV_VERSION..HEAD" >/dev/null 2>&1; then
            COMMIT_RANGE="v$PREV_VERSION..HEAD"
          else
            COMMIT_RANGE="--max-count=50"
          fi
          
          # Build changelog â€” skip internal/plumbing commits
          {
            echo "## WiFi Sentry v$VERSION"
            echo ""
            
            FEATURES=$(git log $COMMIT_RANGE --grep="^feat" \
              --pretty=format:"%s" --no-merges \
              | sed 's/^feat[^:]*: //' | sed 's/^/- /' || true)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ New Features"
              echo "$FEATURES"
              echo ""
            fi
            
            FIXES=$(git log $COMMIT_RANGE --grep="^fix" \
              --pretty=format:"%s" --no-merges \
              | sed 's/^fix[^:]*: //' | sed 's/^/- /' || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            DOCS=$(git log $COMMIT_RANGE --grep="^docs" \
              --pretty=format:"%s" --no-merges \
              | sed 's/^docs[^:]*: //' | sed 's/^/- /' || true)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation"
              echo "$DOCS"
              echo ""
            fi
            
            echo "---"
            echo "**Download:** see the assets below."
            echo ""
            echo "| Platform | Artifact |"
            echo "|---|---|"
            echo "| Android (native APK) | \`app-dev-release.apk\` â€” install directly, no server needed |"
            echo "| Windows Desktop | \`.exe\` installer |"
            echo "| Web PWA | \`.tar.gz\` / \`.zip\` archive (requires \`npm start\`) |"
            echo ""
            echo "Full install guide: [README.md](README.md)"
            
          } > changelog.md
          
          # Output markdown (escape for GitHub output)
          CHANGELOG=$(cat changelog.md)
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "body=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  create-backup-branch:
    needs: detect-version
    if: needs.detect-version.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create version backup branch
        run: |
          VERSION=${{ needs.detect-version.outputs.version }}
          BRANCH_NAME="release/v$VERSION"
          
          echo "ðŸ“¦ Creating backup branch: $BRANCH_NAME"
          
          # Create branch from current HEAD
          git branch $BRANCH_NAME HEAD
          
          # Push branch
          git push origin $BRANCH_NAME
          
          echo "âœ… Backup branch created: $BRANCH_NAME"

      - name: Create git tag
        run: |
          VERSION=${{ needs.detect-version.outputs.version }}
          TAG_NAME="v$VERSION"
          
          echo "ðŸ·ï¸  Creating version tag: $TAG_NAME"
          
          # Create annotated tag with message
          git tag -a $TAG_NAME -m "Release version $VERSION" HEAD
          
          # Push tag
          git push origin $TAG_NAME
          
          echo "âœ… Git tag created: $TAG_NAME"

  publish-release:
    needs: [detect-version, generate-changelog, create-backup-branch]
    if: needs.detect-version.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Get release notes
        id: notes
        run: |
          # Read generated changelog
          BODY=$(cat changelog.md)
          
          # Escape for GitHub API
          BODY="${BODY//'%'/'%25'}"
          BODY="${BODY//$'\n'/'%0A'}"
          BODY="${BODY//$'\r'/'%0D'}"
          echo "body=$BODY" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: WiFi Sentry v${{ needs.detect-version.outputs.version }}
          body: ${{ steps.notes.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish release assets
        run: |
          echo "ðŸ“¦ Release v${{ needs.detect-version.outputs.version }} published!"
          echo ""
          echo "ðŸ“ Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.detect-version.outputs.version }}"
          echo "ðŸ”— Backup branch: release/v${{ needs.detect-version.outputs.version }}"
          echo "ðŸ·ï¸  Tag: v${{ needs.detect-version.outputs.version }}"

  build-release-artifacts:
    name: Build and attach release artifacts
    needs: [detect-version, publish-release]
    uses: ./.github/workflows/release.yml
    with:
      version: v${{ needs.detect-version.outputs.version }}
    secrets: inherit

  notify-release:
    needs: [detect-version, publish-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release Summary
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          PREV_VERSION="v${{ needs.detect-version.outputs.previous-version }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
          PUBLISH_RESULT="${{ needs.publish-release.result }}"

          if [ "$PUBLISH_RESULT" = "success" ]; then
            echo "## âœ… WiFi Sentry ${VERSION} Released" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Release automation completed successfully." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## âš ï¸ WiFi Sentry ${VERSION} â€” Release Issue" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The release job did not succeed. Check the jobs above for details." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**[ðŸ”— View GitHub Release](${RELEASE_URL})**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Previous version | \`${PREV_VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| New version | \`${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backup branch | \`release/${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
